# codecks-cli Docker Compose services
# Usage: docker compose run --rm <service> [args...]

x-common: &common
  build: .
  image: codecks-cli
  volumes:
    - .:/app
  env_file:
    - path: .env
      required: false
  working_dir: /app
  security_opt:
    - no-new-privileges:true
  cap_drop:
    - ALL
  pids_limit: 256
  tmpfs:
    - /tmp:size=64M

services:
  # Run any CLI command: docker compose run --rm cli cards --format table
  cli:
    <<: *common
    entrypoint: ["python", "codecks_api.py"]

  # Run tests: docker compose run --rm test
  test:
    <<: *common
    command: ["pytest", "tests/", "-v", "--basetemp", ".tmp/pytest-docker"]

  # Full quality gate: docker compose run --rm quality
  quality:
    <<: *common
    command:
      - sh
      - -c
      - |
        echo "=== Ruff lint ===" && ruff check . &&
        echo "=== Ruff format ===" && ruff format --check . &&
        echo "=== Mypy ===" && python scripts/quality_gate.py --mypy-only &&
        echo "=== Pytest ===" && pytest tests/ -v --basetemp .tmp/pytest-docker &&
        echo "=== All checks passed ==="

  # Lint only: docker compose run --rm lint
  lint:
    <<: *common
    command: ["sh", "-c", "ruff check . && ruff format --check ."]

  # Type check only: docker compose run --rm typecheck
  typecheck:
    <<: *common
    command: ["python", "scripts/quality_gate.py", "--mypy-only"]

  # MCP server (stdio): docker compose run --rm mcp
  mcp:
    <<: *common
    command: ["python", "-m", "codecks_cli.mcp_server"]
    stdin_open: true

  # MCP server (HTTP): docker compose up mcp-http
  mcp-http:
    <<: *common
    command: ["python", "scripts/run_mcp_http.py"]
    ports:
      - "${MCP_HTTP_PORT:-8808}:8808"
    healthcheck:
      test: ["CMD", "python", "-c",
        "import socket; s=socket.create_connection(('localhost',8808),timeout=3); s.close()"]
      interval: 30s
      timeout: 5s
      start_period: 10s
      retries: 3

  # Interactive shell: docker compose run --rm shell
  shell:
    <<: *common
    entrypoint: ["/bin/bash"]
    stdin_open: true
    tty: true
