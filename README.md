# CoDecks for Hafu

A command-line tool for managing [Codecks.io](https://codecks.io) cards, decks, and projects. Built as an AI agent helper for [Claude Code](https://claude.ai/claude-code), but works just as well from a regular terminal.

## Why this exists

Codecks doesn't have a public REST API with standard endpoints. Instead it uses a custom JSON query language and dispatch-based mutations. This script wraps all of that into simple CLI commands so an AI agent (or a human) can manage cards without touching the browser.

## Requirements

- **Python 3.10+** (tested with 3.11.4)
- A [Codecks](https://codecks.io) account (free tier works)
- A `.env` file with your credentials (see Setup)

No external dependencies. Uses only Python standard library (`urllib`, `json`, `os`, `sys`, `re`).

## Setup

### 1. Clone the repo

```bash
git clone https://github.com/rangogamedev/CoDecksForHafu.git
cd CoDecksForHafu
```

### 2. Create a `.env` file

Create a file called `.env` in the project root (it's gitignored, so your tokens stay safe):

```env
CODECKS_ACCOUNT=your-account-name
CODECKS_TOKEN=your-session-token
CODECKS_ACCESS_KEY=your-access-key
CODECKS_REPORT_TOKEN=your-report-token

# Project name mapping (the API can't query project names directly)
CODECKS_PROJECTS=project-uuid-1=Project Name,project-uuid-2=Other Project

# Milestone name mapping (same reason)
CODECKS_MILESTONES=milestone-uuid-1=Milestone Name
```

### 3. Get your tokens

| Token | Where to find it | What it does |
|-------|-----------------|--------------|
| `CODECKS_TOKEN` | Browser DevTools > Network tab > any `api.codecks.io` request > Cookie header > `at=...` value | Reads data and performs mutations. Expires with your browser session. |
| `CODECKS_ACCESS_KEY` | Codecks > Settings > Integrations > User Reporting > Access Key | Generates new report tokens. Does not expire. |
| `CODECKS_REPORT_TOKEN` | Auto-generated by `generate-token` command, or found in Codecks integration settings | Creates cards via the stable reporting API. Does not expire unless disabled. |

### 4. Map your projects and milestones

The Codecks API doesn't expose project or milestone names through queries, so you store the mapping in `.env`. To find your project and milestone UUIDs:

```bash
# List all decks (each deck shows its projectId)
py codecks_api.py decks

# Then add the mapping to .env:
# CODECKS_PROJECTS=uuid1=My Project,uuid2=Other Project

# For milestones, check card data for milestoneId values:
py codecks_api.py cards
# Then add: CODECKS_MILESTONES=uuid1=MVP,uuid2=Beta
```

## Usage

Run commands with `py codecks_api.py <command>`. On Mac/Linux you may need `python3` instead of `py`.

### Reading data

```bash
# Account info
py codecks_api.py account

# List all cards
py codecks_api.py cards

# Filter cards
py codecks_api.py cards --deck "Coding"
py codecks_api.py cards --status started
py codecks_api.py cards --project "My Project"
py codecks_api.py cards --search "inventory"

# Combine filters
py codecks_api.py cards --project "My Project" --status started --search "bug"

# Card statistics (counts by status, priority, deck)
py codecks_api.py cards --stats
py codecks_api.py cards --project "My Project" --stats

# Single card details (includes sub-cards)
py codecks_api.py card <card-id>

# Decks, projects, milestones
py codecks_api.py decks
py codecks_api.py projects
py codecks_api.py milestones
```

### Creating cards

```bash
# Simple card
py codecks_api.py create "Fix login bug"

# Card with description and severity
py codecks_api.py create "Server crash on startup" --content "Happens after the latest deploy" --severity critical
```

Severity levels: `critical`, `high`, `low`, or `null`.

### Updating cards

```bash
# Change status
py codecks_api.py update <id> --status started

# Set priority (a=high, b=medium, c=low, null=remove)
py codecks_api.py update <id> --priority a

# Set effort points
py codecks_api.py update <id> --effort 5

# Move to a different deck
py codecks_api.py update <id> --deck "In Progress"

# Rename
py codecks_api.py update <id> --title "Better name for this card"

# Update description
py codecks_api.py update <id> --content "Updated description here"

# Assign to a milestone (must be mapped in .env)
py codecks_api.py update <id> --milestone "MVP"

# Clear milestone
py codecks_api.py update <id> --milestone none

# Make a sub-card of a hero card
py codecks_api.py update <id> --hero <parent-card-id>

# Detach from hero
py codecks_api.py update <id> --hero none

# Combine multiple updates in one call
py codecks_api.py update <id> --status started --priority a --effort 3
```

### Bulk status changes

```bash
# Mark one or more cards as done
py codecks_api.py done <id1> <id2> <id3>

# Mark one or more cards as started
py codecks_api.py start <id1> <id2>
```

### Archiving and deleting

```bash
# Archive (reversible)
py codecks_api.py archive <id>

# Unarchive
py codecks_api.py unarchive <id>

# Permanently delete (cannot be undone!)
py codecks_api.py delete <id>
```

### Token management

```bash
# Generate a new report token (saved to .env automatically)
py codecks_api.py generate-token
py codecks_api.py generate-token --label "my-integration"
```

### Advanced: raw API calls

```bash
# Run a raw query
py codecks_api.py query '{"_root": [{"account": ["name", "id"]}]}'

# Run a raw dispatch mutation
py codecks_api.py dispatch cards/update '{"id": "card-uuid", "status": "done"}'
```

## Output formats

By default, all commands output JSON. Add `--format table` to any command for human-readable output:

```bash
# JSON (default, best for AI agents)
py codecks_api.py cards

# Table (best for humans)
py codecks_api.py cards --format table

# Stats as readable text
py codecks_api.py cards --stats --format table

# Works with all read commands
py codecks_api.py decks --format table
py codecks_api.py projects --format table
py codecks_api.py milestones --format table
py codecks_api.py card <id> --format table
```

### Example table output

```
Status         Pri   Eff  Deck                 Title                                    ID
------------------------------------------------------------------------------------------------------------------------
not_started    a     8    Core Systems         Day/Night & Season Cycle                 839c6c81-033d-...
started        b     3    Tasks                Fix inventory drag                       3e770f44-0658-...
done           a     5    Craftable Items      Planks                                   839c6c93-033d-...

Total: 3 cards
```

### Example stats output

```
Total cards: 38
Total effort: 159  Avg effort: 5.3

By Status:
  done               8
  not_started        25
  started            5

By Priority:
  a (high)           20
  b (medium)         11
  c (low)            4
  none               3

By Deck:
  Core Systems       4
  Tasks              6
  ...
```

## Card enrichment

All card output automatically includes resolved names:
- `deck_name` — the deck's title (instead of just `deck_id`)
- `milestone_name` — the milestone's name from `.env` mapping (instead of just `milestone_id`)

These extra fields appear in both JSON and table output.

## Token architecture

The script uses three tokens, each for a different purpose:

| Token | Used for | Auth method | Expiry |
|-------|----------|-------------|--------|
| `CODECKS_TOKEN` | Reading data, updating/archiving/deleting cards | `X-Auth-Token` header | Session (browser cookie) |
| `CODECKS_REPORT_TOKEN` | Creating cards | URL query parameter | Never (until disabled) |
| `CODECKS_ACCESS_KEY` | Generating new report tokens | URL query parameter | Never |

**When the session token expires**, the script prints `[TOKEN_EXPIRED]` and tells you how to get a fresh one from your browser DevTools.

## Known quirks

These are Codecks API behaviors to be aware of:

- **Card title = first line of content.** Renaming a card means updating the first line of its `content` field. The `--title` flag handles this automatically.
- **No project/milestone name queries.** The API doesn't expose these, so they're stored in `.env` as ID-to-name mappings.
- **Response fields are snake_case** (`deck_id`, `project_id`) but query fields are camelCase (`deckId`, `projectId`).
- **Expired tokens return empty data**, not a 401 error. The script detects this and warns you.
- **Rate limit:** 40 requests per 5 seconds per IP.
- **Report tokens in URL params** is the official API design. Treat them as rotatable credentials.

## Using with an AI agent

This script is designed to be called by an AI coding agent like Claude Code. The AI agent should:

1. Default to JSON output (no `--format` flag) for structured parsing
2. Use `--format table` when presenting information to a human
3. Use `--stats` to get a quick overview without dumping every card
4. Use `--search` to find specific cards without scanning everything
5. Chain `--project`, `--deck`, `--status`, and `--search` filters to narrow results
6. Look for the `OK:` prefix on mutation responses to confirm success

The AI agent's project memory file should include the full command reference and the project/milestone UUID mappings.

## File structure

```
CoDecksForHafu/
  codecks_api.py    # The script (all commands)
  .env              # Your tokens and config (gitignored)
  .gitignore        # Protects .env from commits
  README.md         # This file
```

## License

Private project. Not for redistribution.
