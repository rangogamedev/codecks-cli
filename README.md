# codecks-cli

![Python 3.10+](https://img.shields.io/badge/Python-3.10%2B-blue)
![License: MIT](https://img.shields.io/badge/License-MIT-green)

A command-line tool for managing [Codecks.io](https://codecks.io) cards, decks, and projects. Built as an AI agent helper for [Claude Code](https://claude.ai/claude-code), but works just as well from a regular terminal.

> **Experimental** — This tool was built with AI-assisted code generation (vibe-coded with Claude). It works reliably but the command set may evolve. Not affiliated with Codecks. Use at your own risk.

## Why this exists

Codecks doesn't have a public REST API with standard endpoints. Instead it uses a custom JSON query language and dispatch-based mutations. This script wraps all of that into simple CLI commands so an AI agent (or a human) can manage cards without touching the browser.

## Requirements

- **Python 3.10+** (tested with 3.14)
- A [Codecks](https://codecks.io) account (free tier works)
- A `.env` file with your credentials (see Setup)

No external dependencies. Uses only Python standard library (`urllib`, `json`, `os`, `sys`, `re`, `http.server`, `webbrowser`).

## Setup

### 1. Clone the repo

```bash
git clone https://github.com/rangogamedev/codecks-cli.git
cd codecks-cli
```

### 2. Run the setup wizard (recommended)

```bash
py codecks_api.py setup
```

The wizard walks you through everything:
- Your Codecks account name
- Session token (with step-by-step browser instructions)
- Access key and report token (optional, for creating cards)
- Auto-discovers your projects and milestones
- Google Doc URL for GDD sync (optional)

Already set up? Running `setup` again detects your existing config and offers a menu: refresh project/milestone mappings, update your expired token, or start over.

### Manual setup (alternative)

If you prefer to configure manually, copy the example and fill in your values:

```bash
cp .env.example .env
```

You'll need these tokens:

| Token | Where to find it | What it does |
|-------|-----------------|--------------|
| `CODECKS_TOKEN` | Browser DevTools > Network tab > any `api.codecks.io` request > Cookie header > `at=...` value | Reads data and performs mutations. Expires with your browser session. |
| `CODECKS_ACCESS_KEY` | Codecks > Settings > Integrations > User Reporting > Access Key | Generates new report tokens. Does not expire. |
| `CODECKS_REPORT_TOKEN` | Auto-generated by `generate-token` command, or found in Codecks integration settings | Creates cards via the stable reporting API. Does not expire unless disabled. |

The Codecks API doesn't expose project or milestone names, so you store the mapping in `.env`:

```env
CODECKS_PROJECTS=uuid1=My Project,uuid2=Other Project
CODECKS_MILESTONES=uuid1=MVP,uuid2=Beta
```

The `setup` wizard handles this automatically by discovering projects and milestones from your data.

## Usage

Run commands with `py codecks_api.py <command>`. On Mac/Linux you may need `python3` instead of `py`.

### Reading data

```bash
# Account info
py codecks_api.py account

# List all cards
py codecks_api.py cards

# Filter cards
py codecks_api.py cards --deck "Backlog"
py codecks_api.py cards --status started
py codecks_api.py cards --project "My Project"
py codecks_api.py cards --search "inventory"
py codecks_api.py cards --owner "Thomas"
py codecks_api.py cards --owner none               # unassigned cards

# Multi-value filters (comma-separated)
py codecks_api.py cards --status started,blocked    # started OR blocked
py codecks_api.py cards --priority a,b              # high or medium priority
py codecks_api.py cards --priority null             # cards with no priority set

# Date filters and stale detection
py codecks_api.py cards --stale 14                  # not updated in 14 days
py codecks_api.py cards --updated-after 2026-01-01
py codecks_api.py cards --updated-before 2026-02-01
py codecks_api.py cards --status started --stale 7  # combine with other filters

# Combine filters
py codecks_api.py cards --project "My Project" --status started --search "bug"

# Card statistics (counts by status, priority, deck, owner)
py codecks_api.py cards --stats
py codecks_api.py cards --project "My Project" --stats

# Single card details (includes sub-cards, severity, hero parent)
py codecks_api.py card <card-id>

# Decks (with card counts), projects, milestones
py codecks_api.py decks
py codecks_api.py projects
py codecks_api.py milestones

# Recent activity (shows card titles)
py codecks_api.py activity
py codecks_api.py activity --limit 50
```

### Daily standup

Get a quick snapshot of what's done, in progress, blocked, and in your hand:

```bash
# Default: last 2 days of activity
py codecks_api.py standup --format table

# Look back further
py codecks_api.py standup --days 5 --format table

# Filter by project or owner
py codecks_api.py standup --project "My Project" --format table
py codecks_api.py standup --owner "Thomas" --format table
```

The standup report has four sections:
- **Done** — cards marked done within the lookback period
- **In Progress** — cards with started or in-review status
- **Blocked** — blocked cards
- **In Hand** — cards currently in your hand (minus completed ones)

### PM focus (sprint health)

Get a triage view of what needs attention:

```bash
# Sprint health overview
py codecks_api.py pm-focus --format table

# Filter by project
py codecks_api.py pm-focus --project "My Project" --format table

# Customize stale threshold (default: 14 days)
py codecks_api.py pm-focus --stale-days 7 --format table
```

The pm-focus report shows:
- **Blocked** — cards that are stuck
- **Unassigned** — started cards with no owner
- **Started** — all in-progress work
- **In Review** — cards waiting for review
- **Stale** — started or in-review cards not updated in N days (default 14)

### Creating cards

```bash
# Simple card (lands in Inbox by default)
py codecks_api.py create "Fix login bug"

# Card with description and severity
py codecks_api.py create "Server crash on startup" --content "Happens after the latest deploy" --severity critical

# Create directly into a specific deck
py codecks_api.py create "Refactor save system" --deck "Backlog"

# Create into the first deck of a project
py codecks_api.py create "New feature idea" --project "My Project"

# Bypass duplicate-title protection (exact title match)
py codecks_api.py create "Fix login bug" --allow-duplicate
```

Duplicate-title safety:
- Exact title matches now fail fast to prevent accidental duplicate cards.
- Use `--allow-duplicate` to intentionally create a same-title card.
- Near matches are shown as warnings only (they do not block creation).

### Scaffold a feature (Hero + sub-cards, no Journey)

Create one Hero card and linked lane sub-cards for Code/Design/(optional Art):

```bash
py codecks_api.py feature "Inventory 2.0" \
  --hero-deck "Features" \
  --code-deck "Code" \
  --design-deck "Design" \
  --art-deck "Art" \
  --priority a --effort 5
```

For non-visual features:

```bash
py codecks_api.py feature "Economy Tuning" \
  --hero-deck "Features" \
  --code-deck "Code" \
  --design-deck "Design" \
  --skip-art
```

Feature duplicate safety:
- Exact duplicate Hero titles (`Feature: <title>`) are blocked by default.
- Use `--allow-duplicate` when you intentionally want another Hero with the same title.

Transaction safety:
- If feature scaffolding fails after creating some cards, the command performs a best-effort rollback by archiving created cards.
- On rollback issues, the error message reports which card IDs failed to roll back.

Severity levels: `critical`, `high`, `low`, or `null`.

### Updating cards

```bash
# Change status
py codecks_api.py update <id> --status started

# Set priority (a=high, b=medium, c=low, null=remove)
py codecks_api.py update <id> --priority a

# Set effort points
py codecks_api.py update <id> --effort 5

# Move to a different deck
py codecks_api.py update <id> --deck "In Progress"

# Rename
py codecks_api.py update <id> --title "Better name for this card"

# Update description
py codecks_api.py update <id> --content "Updated description here"

# Assign to a milestone (must be mapped in .env)
py codecks_api.py update <id> --milestone "Sprint 1"

# Clear milestone
py codecks_api.py update <id> --milestone none

# Make a sub-card of a hero card
py codecks_api.py update <id> --hero <parent-card-id>

# Detach from hero
py codecks_api.py update <id> --hero none

# Combine multiple updates in one call
py codecks_api.py update <id> --status started --priority a --effort 3
```

### Bulk status changes

```bash
# Mark one or more cards as done
py codecks_api.py done <id1> <id2> <id3>

# Mark one or more cards as started
py codecks_api.py start <id1> <id2>
```

### Archiving and deleting

```bash
# Archive (reversible) — the default way to remove cards
py codecks_api.py archive <id>
py codecks_api.py remove <id>    # same as archive

# Unarchive
py codecks_api.py unarchive <id>

# Permanently delete (requires --confirm flag)
py codecks_api.py delete <id> --confirm
```

Without `--confirm`, `delete` will remind you to use `archive` instead — just like Codecks does in the browser.

### Token management

```bash
# Generate a new report token (saved to .env automatically)
py codecks_api.py generate-token
py codecks_api.py generate-token --label "my-integration"
```

### Advanced: raw API calls

```bash
# Run a raw query
py codecks_api.py query '{"_root": [{"account": ["name", "id"]}]}'

# Run a raw dispatch mutation
py codecks_api.py dispatch cards/update '{"id": "card-uuid", "status": "done"}'
```

## GDD Sync (Game Design Document)

Read a Game Design Document and sync tasks to Codecks. The GDD can come from a Google Doc (shared publicly), a local markdown file, or piped from stdin (for AI agents that read docs via MCP).

### Setup

Add your Google Doc URL to `.env` (share the doc with "Anyone with the link can view"):

```env
GDD_GOOGLE_DOC_URL=https://docs.google.com/document/d/your-doc-id/edit
```

Or use a local file with `--file`, or pipe content with `--file -`.

### GDD format

Use `## Headings` for sections (map to decks) and `- bullets` for tasks:

```markdown
## Core Gameplay
- [P:a E:8] Implement day/night cycle
- [P:a E:5] Save/load system
  - Auto-save every 5 minutes
  - Manual save slots
- [P:b E:3] Inventory drag & drop
```

Tags are optional: `[P:a]` = priority (a/b/c), `[E:5]` = effort, `[P:a E:5]` = both.

### Commands

```bash
# View parsed GDD tasks
py codecks_api.py gdd --format table

# Re-fetch from Google Doc (ignore cache)
py codecks_api.py gdd --refresh --format table

# Use a local file
py codecks_api.py gdd --file "my_gdd.md" --format table

# Dry-run sync (shows what would be created, no changes)
py codecks_api.py gdd-sync --project "My Project"

# Apply sync (actually creates cards)
py codecks_api.py gdd-sync --project "My Project" --apply

# Sync one section only
py codecks_api.py gdd-sync --project "My Project" --section "Core Gameplay" --apply
```

### How sync works

1. Parses GDD into sections and tasks
2. Fetches existing cards from the target project
3. Compares: exact title match or substring match = "already tracked"
4. With `--apply`: creates new cards, places them in matching decks, sets priority and effort
5. Reports what was created vs. what already existed

### Private Google Docs

If your GDD is private, set up Google OAuth2 (free, one-time, ~5 minutes):

1. Go to [Google Cloud Console](https://console.cloud.google.com/apis/credentials)
2. Create a project (free, no billing needed)
3. Enable the **Google Drive API** (APIs & Services > Library > search "Drive")
4. Create an **OAuth 2.0 Client ID** (Credentials > Create Credentials > OAuth client ID > Desktop app)
5. Copy the Client ID and Client Secret to your `.env`:
   ```env
   GOOGLE_CLIENT_ID=your-client-id.apps.googleusercontent.com
   GOOGLE_CLIENT_SECRET=your-client-secret
   ```
6. Run the authorization flow (opens your browser):
   ```bash
   py codecks_api.py gdd-auth
   ```
7. Done! The script will now fetch your private Google Doc automatically. Tokens refresh silently.

To revoke access later: `py codecks_api.py gdd-revoke`

**Other options** (no OAuth needed):
- **Local file**: Export the Google Doc as `.md` and use `--file "path/to/gdd.md"`
- **AI agent piping**: `--file -` reads from stdin. Add `--save-cache` to save for offline use.
- **Public with obscurity**: Use "Anyone with the link" sharing — the doc isn't indexed or discoverable

## Output formats

By default, all commands output JSON. Add `--format table` for human-readable output, or `--format csv` for spreadsheet-compatible output:

```bash
# JSON (default, best for AI agents)
py codecks_api.py cards

# Table (best for humans)
py codecks_api.py cards --format table

# Stats as readable text
py codecks_api.py cards --stats --format table

# Works with all read commands
py codecks_api.py decks --format table
py codecks_api.py projects --format table
py codecks_api.py milestones --format table
py codecks_api.py card <id> --format table
```

### Example table output

```
Status         Pri   Eff  Owner      Deck              Mstone     Title                                ID
------------------------------------------------------------------------------------------------------------
not_started    a     8    Thomas     Core Systems      MVP        Implement save/load system           abc12345-...
started        b     3    -          Tasks             -          Fix inventory drag & drop …          def67890-...
done           a     5    Alice      Backlog           Beta       Database migration                   ghi24680-...

Total: 3 cards
```

Long titles, deck names, and milestones are truncated with `…` so the table stays readable.

### Example stats output

```
Total cards: 38
Total effort: 159  Avg effort: 5.3

By Status:
  done               8
  not_started        25
  started            5

By Priority:
  a (high)           20
  b (medium)         11
  c (low)            4
  none               3

By Deck:
  Backlog            4
  Tasks              6
  ...

By Owner:
  Thomas             15
  Alice              12
  unassigned         11
```

## Card enrichment

All card output automatically includes resolved names and extra context:
- `deck_name` — the deck's title (instead of just `deck_id`)
- `owner_name` — the assignee's display name (instead of raw user ID)
- `milestone_name` — the milestone's name from `.env` mapping (instead of just `milestone_id`)
- `tags` — normalized tag list from `masterTags`
- `sub_card_count` — number of sub-cards for hero cards

Single card detail (`card <id>`) also shows severity and parent hero card when present.

These extra fields appear in both JSON and table output.

## Token architecture

The script uses three tokens, each for a different purpose:

| Token | Used for | Auth method | Expiry |
|-------|----------|-------------|--------|
| `CODECKS_TOKEN` | Reading data, updating/archiving/deleting cards | `X-Auth-Token` header | Session (browser cookie) |
| `CODECKS_REPORT_TOKEN` | Creating cards | URL query parameter | Never (until disabled) |
| `CODECKS_ACCESS_KEY` | Generating new report tokens | URL query parameter | Never |

**The session token is validated automatically** every time you run a command. If it's expired, the script prints `[TOKEN_EXPIRED]` with instructions to refresh it (or run `setup` again). If no configuration exists at all, it prints `[SETUP_NEEDED]`. All other errors are prefixed with `[ERROR]` for easy detection.
With `--format json`, errors are emitted as JSON envelopes on stderr (`{"ok": false, "error": ...}`) so AI agents can parse failures consistently.
Use `--strict` for fail-fast agent mode on raw API workflows (`query`/`dispatch`) when ambiguous responses should be treated as errors.

## Known quirks

These are Codecks API behaviors to be aware of:

- **Card title = first line of content.** Renaming a card means updating the first line of its `content` field. The `--title` flag handles this automatically.
- **No project/milestone name queries.** The API doesn't expose these, so they're stored in `.env` as ID-to-name mappings.
- **Response fields are snake_case** (`deck_id`, `project_id`) but query fields are camelCase (`deckId`, `projectId`).
- **Expired tokens return empty data**, not a 401 error. The script detects this and warns you.
- **Rate limit:** 40 requests per 5 seconds per IP.
- **Configurable HTTP timeout** (default 30s) on all requests to prevent hangs.
- **Safe retries for read/query calls** on transient gateway errors (`429/502/503/504`) with backoff.
- **Per-request tracing header** (`X-Request-Id`) is sent for easier API/gateway log correlation.
- **Optional structured HTTP logs** to stderr via `CODECKS_HTTP_LOG=true` (secrets in URL query are masked), with sampling via `CODECKS_HTTP_LOG_SAMPLE_RATE`.
- **Delete requires `--confirm`** to prevent accidental permanent deletion. Without it, the script suggests `archive` instead.
- **Report tokens in URL params** is the official API design. Treat them as rotatable credentials.

## Using with an AI agent

This script is designed to be called by an AI coding agent like Claude Code. The AI agent should:

1. Default to JSON output (no `--format` flag) for structured parsing
2. Use `--format table` when presenting information to a human
3. Start sessions with `standup` for an immediate status snapshot
4. Use `pm-focus` for sprint health checks (blocked, stale, unassigned cards)
5. Use `--stats` to get a quick overview without dumping every card
6. Use `--search` to find specific cards without scanning everything
7. Use comma-separated `--status` and `--priority` for multi-value filters
8. Use `--stale <days>` to find neglected cards, `--owner none` for unassigned work
9. Chain `--project`, `--deck`, `--status`, `--priority`, and `--search` filters to narrow results
10. For non-strict mode, look for `OK:` on mutation responses; in strict JSON mode parse structured mutation JSON
11. Check for `[ERROR]` prefix to detect failures, and `[TOKEN_EXPIRED]` for expired sessions
12. Use `create --deck "Name"` to place cards directly — avoids a separate `update` call
13. Use `remove` as a natural alias for `archive`
14. Use `gdd-sync --project "Name"` for dry-run, add `--apply` only after reviewing the report
15. Pipe GDD content via `--file -` if the agent has its own document access (e.g. MCP)

The AI agent's project memory file should include the full command reference and the project/milestone UUID mappings.

### Token efficiency

The script is optimized to minimize context window usage for AI agents:

- **Card lists omit descriptions** — the `content` field is only included when using `--search` (which needs it for matching). Use `card <id>` to get full details for a specific card.
- **Mutation responses are clean** — non-strict mode prints `OK: ...`; strict+JSON mode emits structured JSON mutation envelopes for agent parsing.
- **API metadata is stripped** — internal `_root` keys are removed from all query responses.
- **Deck lookups are cached** — commands that need deck data make only one API call per invocation, even if multiple filters reference decks.

## File structure

```
codecks-cli/
  codecks_api.py    # Entry point — argparse, help text, command dispatch
  config.py         # Constants, .env loading, module-level state
  models.py         # Typed input/output contracts for feature and raw payloads
  api.py            # HTTP layer, security helpers, token validation
  cards.py          # Card CRUD, hand ops, conversations, enrichment
  commands.py       # Command handlers (one cmd_*() per CLI command)
  formatters.py     # Table, CSV, JSON output formatters
  gdd.py            # Google OAuth2, GDD fetch/parse/sync
  setup_wizard.py   # Interactive setup wizard
  tests/            # pytest unit tests (no live API calls)
  .env              # Your tokens and config (gitignored)
  .env.example      # Template showing required env vars
  .gitignore        # Protects .env from commits
  README.md         # This file
  LICENSE           # MIT license
  CONTRIBUTING.md   # How to contribute
  SECURITY.md       # Vulnerability reporting
  CHANGELOG.md      # Version history
```

## Contributing

Contributions welcome! See [CONTRIBUTING.md](CONTRIBUTING.md) for guidelines.

## Quality Checks

The project keeps **runtime dependencies at zero** (stdlib only), while using
optional dev tooling for quality gates.

Install dev tools:

```powershell
py -m pip install .[dev]
```

Run checks:

```powershell
py -m ruff check .
py -m ruff format --check .
py -m mypy codecks_cli/api.py codecks_cli/cards.py codecks_cli/client.py codecks_cli/commands.py codecks_cli/formatters/ codecks_cli/models.py codecks_cli/exceptions.py codecks_cli/_utils.py codecks_cli/types.py
pwsh -File scripts/run-tests.ps1
```

`scripts/run-tests.ps1` sets `TEMP`/`TMP` to `.tmp/` and uses a unique
`.tmp/pytest-<timestamp>-<pid>` base temp per run to reduce Windows lock/permission collisions.
It prefers `py` and falls back to `CODECKS_PYTHON_PATH` (or
`C:\Users\USER\AppData\Local\Python\bin\python.exe`).

## Security

Found a vulnerability? See [SECURITY.md](SECURITY.md) for responsible disclosure.

## License

MIT License — see [LICENSE](LICENSE) for details.
