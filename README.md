# codecks-cli

![Python 3.10+](https://img.shields.io/badge/Python-3.10%2B-blue)
![License: MIT](https://img.shields.io/badge/License-MIT-green)
![Tests: 491](https://img.shields.io/badge/Tests-491-brightgreen)

A command-line tool and Python library for managing [Codecks.io](https://codecks.io) cards, decks, and projects. Zero runtime dependencies. Works from a terminal, as a Python API, or as an MCP server for AI agents.

## Table of Contents

- [Installation](#installation)
- [Quick Start](#quick-start)
- [CLI Reference](#cli-reference)
- [Python API](#python-api)
- [MCP Server](#mcp-server)
- [GDD Sync](#gdd-sync-game-design-document)
- [Output Formats](#output-formats)
- [Token Architecture](#token-architecture)
- [Project Structure](#project-structure)
- [Contributing](#contributing)
- [License](#license)

## Installation

### From source (recommended)

```bash
git clone https://github.com/rangogamedev/codecks-cli.git
cd codecks-cli
py -m pip install .
```

This installs two entry points:

| Command | What it does |
|---------|-------------|
| `codecks-cli` | CLI tool |
| `codecks-mcp` | MCP server for AI agents |

You can also run directly without installing: `py codecks_api.py <command>`

### Requirements

- **Python 3.10+** (tested with 3.14)
- A [Codecks](https://codecks.io) account (free tier works)
- Zero runtime dependencies (stdlib only)

### Docker (optional)

Run everything in a sandboxed Linux container — no Python install needed on the host.

```bash
# Build the image (once, or after changing dependencies)
./docker/build.sh

# Run tests, quality checks, or any CLI command
./docker/test.sh
./docker/quality.sh
./docker/cli.sh cards --format table

# Start MCP server or drop into a shell
./docker/mcp.sh
./docker/shell.sh
```

Requires [Docker Desktop](https://www.docker.com/products/docker-desktop/). Your source code is volume-mounted (edits reflect instantly) and `.env` secrets are passed as environment variables, never baked into the image.

### Dev tools (optional)

```bash
py -m pip install .[dev]   # ruff, mypy, pytest-cov
py -m pip install .[mcp]   # MCP server (mcp[cli])
```

## Quick Start

```bash
# Interactive setup wizard — walks you through tokens, projects, milestones
codecks-cli setup

# List your cards
codecks-cli cards --format table

# Create a card
codecks-cli create "Fix login bug" --deck "Backlog"

# Daily standup snapshot
codecks-cli standup --format table
```

Already set up? Running `setup` again detects your existing config and offers a menu: refresh project/milestone mappings, update your expired token, or start over.

### Manual setup (alternative)

Copy the example and fill in your values:

```bash
cp .env.example .env
```

| Token | Where to find it | What it does |
|-------|-----------------|--------------|
| `CODECKS_TOKEN` | Browser DevTools > Network tab > any `api.codecks.io` request > Cookie header > `at=...` value | Reads data and performs mutations. Expires with your browser session. |
| `CODECKS_ACCESS_KEY` | Codecks > Settings > Integrations > User Reporting > Access Key | Generates new report tokens. Does not expire. |
| `CODECKS_REPORT_TOKEN` | Auto-generated by `generate-token` command, or found in Codecks integration settings | Creates cards via the stable reporting API. Does not expire unless disabled. |

The Codecks API doesn't expose project or milestone names, so you store the mapping in `.env`:

```env
CODECKS_PROJECTS=uuid1=My Project,uuid2=Other Project
CODECKS_MILESTONES=uuid1=MVP,uuid2=Beta
```

The `setup` wizard handles this automatically by discovering projects and milestones from your data.

## CLI Reference

Run commands with `codecks-cli <command>` (or `py codecks_api.py <command>` if not installed).

### Reading data

```bash
# Account info
codecks-cli account

# List all cards
codecks-cli cards

# Filter cards
codecks-cli cards --deck "Backlog"
codecks-cli cards --status started
codecks-cli cards --project "My Project"
codecks-cli cards --search "inventory"
codecks-cli cards --owner "Thomas"
codecks-cli cards --owner none               # unassigned cards
codecks-cli cards --milestone "Sprint 1"

# Multi-value filters (comma-separated)
codecks-cli cards --status started,blocked    # started OR blocked
codecks-cli cards --priority a,b              # high or medium priority
codecks-cli cards --priority null             # cards with no priority set

# Date filters and stale detection
codecks-cli cards --stale 14                  # not updated in 14 days
codecks-cli cards --updated-after 2026-01-01
codecks-cli cards --updated-before 2026-02-01
codecks-cli cards --status started --stale 7  # combine with other filters

# Combine filters
codecks-cli cards --project "My Project" --status started --search "bug"

# Card statistics (counts by status, priority, deck, owner)
codecks-cli cards --stats
codecks-cli cards --project "My Project" --stats

# Single card details (includes sub-cards, severity, hero parent)
codecks-cli card <card-id>

# Decks (with card counts), projects, milestones
codecks-cli decks
codecks-cli projects
codecks-cli milestones

# Recent activity (shows card titles)
codecks-cli activity
codecks-cli activity --limit 50
```

### Daily standup

Get a quick snapshot of what's done, in progress, blocked, and in your hand:

```bash
# Default: last 2 days of activity
codecks-cli standup --format table

# Look back further
codecks-cli standup --days 5 --format table

# Filter by project or owner
codecks-cli standup --project "My Project" --format table
codecks-cli standup --owner "Thomas" --format table
```

The standup report has four sections:
- **Done** — cards marked done within the lookback period
- **In Progress** — cards with started or in-review status
- **Blocked** — blocked cards
- **In Hand** — cards currently in your hand (minus completed ones)

### PM focus (sprint health)

Get a triage view of what needs attention:

```bash
# Sprint health overview
codecks-cli pm-focus --format table

# Filter by project
codecks-cli pm-focus --project "My Project" --format table

# Customize stale threshold (default: 14 days)
codecks-cli pm-focus --stale-days 7 --format table
```

The pm-focus report shows:
- **Blocked** — cards that are stuck
- **Unassigned** — started cards with no owner
- **Started** — all in-progress work
- **In Review** — cards waiting for review
- **Stale** — started or in-review cards not updated in N days (default 14)

### Creating cards

```bash
# Simple card (lands in Inbox by default)
codecks-cli create "Fix login bug"

# Card with description and severity
codecks-cli create "Server crash on startup" --content "Happens after the latest deploy" --severity critical

# Create directly into a specific deck
codecks-cli create "Refactor save system" --deck "Backlog"

# Create into the first deck of a project
codecks-cli create "New feature idea" --project "My Project"

# Bypass duplicate-title protection (exact title match)
codecks-cli create "Fix login bug" --allow-duplicate
```

Duplicate-title safety:
- Exact title matches now fail fast to prevent accidental duplicate cards.
- Use `--allow-duplicate` to intentionally create a same-title card.
- Near matches are shown as warnings only (they do not block creation).

### Scaffold a feature (Hero + sub-cards)

Create one Hero card and linked lane sub-cards for Code/Design/(optional Art):

```bash
codecks-cli feature "Inventory 2.0" \
  --hero-deck "Features" \
  --code-deck "Code" \
  --design-deck "Design" \
  --art-deck "Art" \
  --priority a --effort 5
```

For non-visual features:

```bash
codecks-cli feature "Economy Tuning" \
  --hero-deck "Features" \
  --code-deck "Code" \
  --design-deck "Design" \
  --skip-art
```

Feature duplicate safety:
- Exact duplicate Hero titles (`Feature: <title>`) are blocked by default.
- Use `--allow-duplicate` when you intentionally want another Hero with the same title.

Transaction safety:
- If feature scaffolding fails after creating some cards, the command performs a best-effort rollback by archiving created cards.
- On rollback issues, the error message reports which card IDs failed to roll back.

Severity levels: `critical`, `high`, `low`, or `null`.

### Updating cards

```bash
# Change status
codecks-cli update <id> --status started

# Set priority (a=high, b=medium, c=low, null=remove)
codecks-cli update <id> --priority a

# Set effort points
codecks-cli update <id> --effort 5

# Move to a different deck
codecks-cli update <id> --deck "In Progress"

# Rename
codecks-cli update <id> --title "Better name for this card"

# Update description
codecks-cli update <id> --content "Updated description here"

# Assign or unassign an owner
codecks-cli update <id> --owner "Thomas"
codecks-cli update <id> --owner none

# Manage tags
codecks-cli update <id> --tags "bug,urgent"
codecks-cli update <id> --tags none

# Assign to a milestone (must be mapped in .env)
codecks-cli update <id> --milestone "Sprint 1"

# Clear milestone
codecks-cli update <id> --milestone none

# Make a sub-card of a hero card
codecks-cli update <id> --hero <parent-card-id>

# Detach from hero
codecks-cli update <id> --hero none

# Combine multiple updates in one call
codecks-cli update <id> --status started --priority a --effort 3
```

### Hand management

```bash
# View cards in your hand
codecks-cli hand

# Add cards to your hand
codecks-cli hand <id1> <id2>

# Remove cards from your hand
codecks-cli unhand <id1> <id2>
```

### Comments

```bash
# Add a comment to a card
codecks-cli comment <card-id> "This needs review"

# Reply in a thread
codecks-cli comment <card-id> "Good point" --thread <comment-id>

# Close a comment thread
codecks-cli comment <card-id> --close <comment-id>

# Reopen a comment thread
codecks-cli comment <card-id> --reopen <comment-id>

# List all conversations on a card
codecks-cli conversations <card-id>
```

### Bulk status changes

```bash
# Mark one or more cards as done
codecks-cli done <id1> <id2> <id3>

# Mark one or more cards as started
codecks-cli start <id1> <id2>
```

### Archiving and deleting

```bash
# Archive (reversible) — the default way to remove cards
codecks-cli archive <id>
codecks-cli remove <id>    # same as archive

# Unarchive
codecks-cli unarchive <id>

# Permanently delete (requires --confirm flag)
codecks-cli delete <id> --confirm
```

Without `--confirm`, `delete` will remind you to use `archive` instead — just like Codecks does in the browser.

### Shell completion

```bash
# Generate shell completions
codecks-cli completion --shell bash
codecks-cli completion --shell zsh
codecks-cli completion --shell fish
```

### Token management

```bash
# Generate a new report token (saved to .env automatically)
codecks-cli generate-token
codecks-cli generate-token --label "my-integration"
```

### Global flags

| Flag | Description |
|------|-------------|
| `--format json\|table\|csv` | Output format (default: json) |
| `--strict` | Fail-fast agent mode for raw API workflows |
| `--dry-run` | Preview mutations without executing |
| `--quiet` / `-q` | Suppress confirmations and warnings |
| `--verbose` / `-v` | Enable HTTP request logging |
| `--version` | Show version and exit |

`--quiet` and `--verbose` are mutually exclusive.

### Advanced: raw API calls

```bash
# Run a raw query
codecks-cli query '{"_root": [{"account": ["name", "id"]}]}'

# Run a raw dispatch mutation
codecks-cli dispatch cards/update '{"id": "card-uuid", "status": "done"}'
```

## Python API

codecks-cli ships a typed Python library with `py.typed` marker for editor support.

```python
from codecks_cli import CodecksClient

client = CodecksClient()  # validates token on init

# List cards with filters
cards = client.list_cards(status="started", sort="priority")

# Create a card
result = client.create_card(title="Fix login bug", deck="Backlog")

# Update cards
client.update_cards(card_ids=["abc-123"], status="done", priority="a")

# Standup report
report = client.standup(days=3, project="My Project")
```

### 27 methods

| Category | Methods |
|----------|---------|
| **Read** | `get_account`, `list_cards`, `get_card`, `list_decks`, `list_projects`, `list_milestones`, `list_activity`, `pm_focus`, `standup` |
| **Hand** | `list_hand`, `add_to_hand`, `remove_from_hand` |
| **Mutations** | `create_card`, `update_cards`, `mark_done`, `mark_started`, `archive_card`, `unarchive_card`, `delete_card`, `scaffold_feature` |
| **Comments** | `create_comment`, `reply_comment`, `close_comment`, `reopen_comment`, `list_conversations` |
| **Raw API** | `raw_query`, `raw_dispatch` |

All methods use keyword-only arguments and return flat `dict[str, Any]` for easy consumption by AI agents and scripts.

## MCP Server

The MCP (Model Context Protocol) server exposes 33 tools for AI agents like Claude Code, enabling full Codecks management from within an AI conversation.

### Setup

```bash
# Install MCP dependency
py -m pip install .[mcp]

# Run the server (stdio transport)
codecks-mcp
# or: py -m codecks_cli.mcp_server
```

### Claude Code configuration

Add to your MCP settings:

```json
{
  "mcpServers": {
    "codecks": {
      "command": "codecks-mcp",
      "args": []
    }
  }
}
```

### 33 tools

| Category | Tools |
|----------|-------|
| **Read** (9) | `get_account`, `list_cards`, `get_card`, `list_decks`, `list_projects`, `list_milestones`, `list_activity`, `pm_focus`, `standup` |
| **Hand** (3) | `list_hand`, `add_to_hand`, `remove_from_hand` |
| **Mutations** (9) | `create_card`, `update_cards`, `mark_done`, `mark_started`, `archive_card`, `unarchive_card`, `delete_card`, `scaffold_feature`, `split_features` |
| **Comments** (5) | `create_comment`, `reply_comment`, `close_comment`, `reopen_comment`, `list_conversations` |
| **PM Session** (3) | `get_pm_playbook`, `get_workflow_preferences`, `save_workflow_preferences` |
| **Planning** (4) | `planning_init`, `planning_status`, `planning_update`, `planning_measure` |

### Features

- **Cached client** — single `CodecksClient` instance reused across tool calls
- **Literal types** — enum parameters (status, priority, sort) use Literal types for validation
- **Pagination** — `list_cards` supports limit/offset (default 50 cards per page)
- **Agent-friendly docstrings** — "when to use" hints, return shapes, and gotchas in every tool
- **Token-efficient responses** — card lists omit descriptions, API metadata is stripped

## GDD Sync (Game Design Document)

Read a Game Design Document and sync tasks to Codecks. The GDD can come from a Google Doc (shared publicly), a local markdown file, or piped from stdin (for AI agents that read docs via MCP).

### Setup

Add your Google Doc URL to `.env` (share the doc with "Anyone with the link can view"):

```env
GDD_GOOGLE_DOC_URL=https://docs.google.com/document/d/your-doc-id/edit
```

Or use a local file with `--file`, or pipe content with `--file -`.

### GDD format

Use `## Headings` for sections (map to decks) and `- bullets` for tasks:

```markdown
## Core Gameplay
- [P:a E:8] Implement day/night cycle
- [P:a E:5] Save/load system
  - Auto-save every 5 minutes
  - Manual save slots
- [P:b E:3] Inventory drag & drop
```

Tags are optional: `[P:a]` = priority (a/b/c), `[E:5]` = effort, `[P:a E:5]` = both.

### Commands

```bash
# View parsed GDD tasks
codecks-cli gdd --format table

# Re-fetch from Google Doc (ignore cache)
codecks-cli gdd --refresh --format table

# Use a local file
codecks-cli gdd --file "my_gdd.md" --format table

# Dry-run sync (shows what would be created, no changes)
codecks-cli gdd-sync --project "My Project"

# Apply sync (actually creates cards)
codecks-cli gdd-sync --project "My Project" --apply

# Sync one section only
codecks-cli gdd-sync --project "My Project" --section "Core Gameplay" --apply
```

### How sync works

1. Parses GDD into sections and tasks
2. Fetches existing cards from the target project
3. Compares: exact title match or substring match = "already tracked"
4. With `--apply`: creates new cards, places them in matching decks, sets priority and effort
5. Reports what was created vs. what already existed

### Private Google Docs

If your GDD is private, set up Google OAuth2 (free, one-time, ~5 minutes):

1. Go to [Google Cloud Console](https://console.cloud.google.com/apis/credentials)
2. Create a project (free, no billing needed)
3. Enable the **Google Drive API** (APIs & Services > Library > search "Drive")
4. Create an **OAuth 2.0 Client ID** (Credentials > Create Credentials > OAuth client ID > Desktop app)
5. Copy the Client ID and Client Secret to your `.env`:
   ```env
   GOOGLE_CLIENT_ID=your-client-id.apps.googleusercontent.com
   GOOGLE_CLIENT_SECRET=your-client-secret
   ```
6. Run the authorization flow (opens your browser):
   ```bash
   codecks-cli gdd-auth
   ```
7. Done! The script will now fetch your private Google Doc automatically. Tokens refresh silently.

To revoke access later: `codecks-cli gdd-revoke`

**Other options** (no OAuth needed):
- **Local file**: Export the Google Doc as `.md` and use `--file "path/to/gdd.md"`
- **AI agent piping**: `--file -` reads from stdin. Add `--save-cache` to save for offline use.
- **Public with obscurity**: Use "Anyone with the link" sharing — the doc isn't indexed or discoverable

## Output formats

By default, all commands output JSON. Add `--format table` for human-readable output, or `--format csv` for spreadsheet-compatible output:

```bash
# JSON (default, best for AI agents)
codecks-cli cards

# Table (best for humans)
codecks-cli cards --format table

# CSV (for spreadsheets)
codecks-cli cards --format csv

# Stats as readable text
codecks-cli cards --stats --format table

# Works with all read commands
codecks-cli decks --format table
codecks-cli projects --format table
codecks-cli milestones --format table
codecks-cli card <id> --format table
```

### Example table output

```
Status         Pri   Eff  Owner      Deck              Mstone     Title                                ID
------------------------------------------------------------------------------------------------------------
not_started    a     8    Thomas     Core Systems      MVP        Implement save/load system           abc12345-...
started        b     3    -          Tasks             -          Fix inventory drag & drop …          def67890-...
done           a     5    Alice      Backlog           Beta       Database migration                   ghi24680-...

Total: 3 cards
```

Long titles, deck names, and milestones are truncated with `…` so the table stays readable.

### Example stats output

```
Total cards: 38
Total effort: 159  Avg effort: 5.3

By Status:
  done               8
  not_started        25
  started            5

By Priority:
  a (high)           20
  b (medium)         11
  c (low)            4
  none               3

By Deck:
  Backlog            4
  Tasks              6
  ...

By Owner:
  Thomas             15
  Alice              12
  unassigned         11
```

## Token architecture

The tool uses three tokens, each for a different purpose:

| Token | Used for | Auth method | Expiry |
|-------|----------|-------------|--------|
| `CODECKS_TOKEN` | Reading data, updating/archiving/deleting cards | `X-Auth-Token` header | Session (browser cookie) |
| `CODECKS_REPORT_TOKEN` | Creating cards | URL query parameter | Never (until disabled) |
| `CODECKS_ACCESS_KEY` | Generating new report tokens | URL query parameter | Never |

The session token is validated automatically every time you run a command. If it's expired, the tool prints `[TOKEN_EXPIRED]` with instructions to refresh it (or run `setup` again). If no configuration exists at all, it prints `[SETUP_NEEDED]`.

With `--format json`, errors are emitted as JSON envelopes on stderr (`{"ok": false, "error": ...}`) so AI agents can parse failures consistently.

API notes:
- **Rate limit:** 40 requests per 5 seconds per IP. Transient errors (429/502/503/504) are retried with backoff.
- **Expired tokens return empty data**, not 401. The tool detects this and warns you.
- **Response fields are snake_case** (`deck_id`) but query fields are camelCase (`deckId`).

## Project structure

```
codecks-cli/
  codecks_api.py              ← CLI entry point (backward-compat wrapper)
  codecks_cli/
    cli.py                    ← argparse, build_parser(), main() dispatch
    commands.py               ← cmd_*() wrappers: argparse → CodecksClient → formatters
    client.py                 ← CodecksClient: 27 public methods (the API surface)
    cards.py                  ← Card CRUD, hand ops, conversations, enrichment
    api.py                    ← HTTP layer: query(), dispatch(), retries, token check
    config.py                 ← Env vars, tokens, constants, runtime state
    exceptions.py             ← CliError, SetupError, HTTPError
    _utils.py                 ← _get_field(), get_card_tags(), date/multi-value parsers
    types.py                  ← TypedDict response shapes (CardRow, CardDetail, etc.)
    models.py                 ← ObjectPayload, FeatureSpec dataclasses
    formatters/               ← JSON/table/CSV output (7 sub-modules)
      __init__.py             re-exports all 24 formatter names
      _table.py               _table(), _trunc(), _sanitize_str()
      _core.py                output(), mutation_response(), pretty_print()
      _cards.py               format_cards_table, format_card_detail, format_cards_csv
      _entities.py            format_decks_table, format_projects_table, format_milestones_table
      _activity.py            format_activity_table, format_activity_diff
      _dashboards.py          format_pm_focus_table, format_standup_table
      _gdd.py                 format_gdd_table, format_sync_report
    gdd.py                    ← Google OAuth2, GDD fetch/parse/sync
    setup_wizard.py           ← Interactive .env bootstrap
    mcp_server.py             ← MCP server: 33 tools (stdio transport)
    pm_playbook.md            ← Agent-agnostic PM methodology
    py.typed                  ← PEP 561 type marker
  tests/                      ← 588 pytest tests (no live API calls)
  .env                        ← Your tokens and config (gitignored)
  .env.example                ← Template showing required env vars
```

## Contributing

Contributions welcome! See [CONTRIBUTING.md](CONTRIBUTING.md) for guidelines.

## Security

Found a vulnerability? See [SECURITY.md](SECURITY.md) for responsible disclosure.

## License

MIT License — see [LICENSE](LICENSE) for details.
